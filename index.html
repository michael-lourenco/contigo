<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conti GO</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signOut, signInWithPopup, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);

        const auth = getAuth(app);

        const db = getFirestore(app);

        let globalDisplayName = '';
        
        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                onAuthStateChanged(auth, async (user) => {

                    if (user) {

                        const userRef = doc(db, 'users', user.email);

                        const docSnap = await getDoc(userRef);

                        if (docSnap.exists()) {

                            const userData = docSnap.data();

                            displayUserInfo(userData.displayName, userData.best);

                            document.getElementById('google-sign-in-button').style.display = 'none';

                            document.getElementById('google-sign-out-button').style.display = 'block';

                        } else {

                            console.error("Usuário não encontrado na coleção 'users'.");

                        }
                    } else {

                        document.getElementById('google-sign-in-button').style.display = 'block';

                        document.getElementById('google-sign-out-button').style.display = 'none';

                    }
                });
            })
            .catch((error) => {

                console.error("Erro ao configurar persistência:", error);

            });
        
        
        async function signInWithGoogle() {
            try {
                const provider = new GoogleAuthProvider();

                const result = await signInWithPopup(auth, provider);

                const user = result.user;

                
                const userRef = doc(db, 'users', user.email);

                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {    
                               
                    const userData = docSnap.data();

                    displayUserInfo(userData.displayName, userData.best);

                } else {          

                    const newUser = {
                        displayName: user.displayName,
                        best: 0
                    };

                    await setDoc(userRef, newUser);

                    displayUserInfo(newUser.displayName, newUser.best);

                }
                                
                document.getElementById('google-sign-in-button').style.display = 'none';

                document.getElementById('google-sign-out-button').style.display = 'block';

            } catch (error) {

                console.error('Erro durante o login:', error);

            }
        }

        window.signInWithGoogle = signInWithGoogle;

        
        async function signOutFromGoogle() {
            try {

                await signOut(auth);
                
                const userInfoContainer = document.getElementById('user-info');

                userInfoContainer.innerHTML = '';

                localStorage.removeItem('user');
                                
                document.getElementById('google-sign-in-button').style.display = 'block';

                document.getElementById('google-sign-out-button').style.display = 'none';

            } catch (error) {

                console.error('Erro durante o logout:', error);

            }
        }

        window.signOutFromGoogle = signOutFromGoogle;

        function displayUserInfo(displayName, best) {

            if(displayName) {

                globalDisplayName = displayName

            }
            
            const userInfoContainer = document.getElementById('user-info');

            userInfoContainer.innerHTML = `
                <p>Nome: ${displayName}</p>
                <p>Melhor Pontuação: ${best}</p>
            `;

        }

        window.displayUserInfo = displayUserInfo;

        function UpdateDbEndGame({ elementGameOver, elementNewGameButton }) {

            const user = JSON.parse(localStorage.getItem('user'));

            if (user) {

                const userRef = doc(db, 'users', user.email);

                getDoc(userRef).then((docSnap) => {

                    if (docSnap.exists()) {

                        const currentBestScore = docSnap.data().best;

                        if (successCount > currentBestScore) {

                            updateDoc(userRef, { best: successCount });

                            displayUserInfo(globalDisplayName, successCount)

                        }
                    }
                });
            }
        }

        window.UpdateDbEndGame = UpdateDbEndGame;
        
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <nav class="menu">

        <div class="logo">
            <a href="index.html">ContiGO</a>
        </div>

        <div class="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>

        <div class="menu-links">
            <div class="donate-container">

                <button id="donate-button" onclick="copyPixKey()">
                    <i class="fas fa-donate"></i> Doar via PIX
                </button>
    
                <p id="pix-message">Chave PIX copiada!</p>
    
            </div>
            <a href="index.html">Jogar</a>
            <a href="how_to_play.html">Como Jogar</a>
            <a href="about.html">Sobre</a>
            <button id="google-sign-in-button" onclick="signInWithGoogle()">Sign in with Google</button>
            <button id="google-sign-out-button" onclick="signOutFromGoogle()" style="display: none;">Sign out</button>
        </div>

    </nav>

    <div class="container">

        <div class="info-container">

            <div class="info-item">
                <i class="fa fa-times-circle fa-icon" aria-hidden="true"></i>
                <span id="errors">0</span>
            </div>

            <div class="info-item">
                <i class="fa fa-check-circle fa-icon" aria-hidden="true"></i>
                <span id="successes">0</span>
            </div>

            <div class="info-item">
                <i class="fa fa-clock fa-icon" aria-hidden="true"></i>
                <span id="general-timer">03:00</span>
            </div>

            <div class="info-item">
                <i class="fa fa-hourglass-half fa-icon" aria-hidden="true"></i>
                <span id="timer">00</span>
            </div>

        </div>
        
        <div id="user-info" class="user-info"></div>

        <div class="number-boxes">

            <div id="firstDice" class="number-box"></div>

            <div id="secondDice" class="number-box"></div>

            <div id="thirdDice" class="number-box"></div>

        </div>

        <div class="input-container">

            <div id="result"></div>

            <div id="game-over"></div>

            <button id="new-game-button" onclick="startNewGame()">Iniciar Novo Jogo</button>

        </div>

    </div>

    <div class="grid-container">

        <div class="grid" id="grid">
            <!-- Grid items will be populated here -->
        </div>
        
    </div>

    <script src="contas.js"></script>
    <script src="gameplay.js"></script>
</body>
</html>
